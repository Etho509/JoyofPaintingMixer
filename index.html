<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GirthyCatboy’s Color Mixer for Joy of Painting</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121923; --muted:#8aa0b2; --text:#e7eef6; --acc:#4aa3ff; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141c 40%,#0b0f14);color:var(--text);font:16px/1.45 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid #1f2a36;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0;font-weight:700}
    p.sub{margin:0;color:var(--muted)}
    .pane{padding:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:800px){.row{grid-template-columns:1fr}}
    label{font-weight:600;font-size:14px}
    input[type="text"],input[type="number"],button,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #223041;background:#0e1420;color:var(--text)}
    input[type="checkbox"]{transform:scale(1.1);vertical-align:middle}
    button{cursor:pointer;background:linear-gradient(180deg,#3e8cff,#2b6fe0);border:1px solid #2d6fdd;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .swatch{width:48px;height:48px;border-radius:10px;border:1px solid #203048}
    .stack{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .result{display:grid;grid-template-columns:1fr;gap:14px}
    .step{padding:12px 14px;border:1px dashed #2a3b52;border-radius:12px;background:#0c131e}
    code{background:#0f1625;border:1px solid #1f2a36;border-radius:8px;padding:2px 6px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #2a3b52;background:#0c131e;margin:2px 6px 2px 0}
    footer{opacity:.85;font-size:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pane">
        <header>
          <div class="swatch" id="targetSwatch" title="Target"></div>
          <div>
            <h1>GirthyCatboy’s Color Mixer for Joy of Painting</h1>
            <p class="sub">Enter a hex color. The app finds dye steps that approximate it using Minecraft’s dye averaging on a <b>white canvas base</b>. Includes an optional IRL mode.</p>
          </div>
        </header>

        <div class="row">
          <div>
            <label for="hex">Target Hex</label>
            <input id="hex" type="text" placeholder="#FFA195" value="#FFA195" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="run">Compute Recipe</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>Search Depth</label>
            <div class="grid-3">
              <div>
                <span class="muted">One-step: max dyes</span>
                <input id="d1" type="number" min="1" max="6" value="4" />
              </div>
              <div>
                <span class="muted">Two-step: max dyes/step</span>
                <input id="d2" type="number" min="1" max="5" value="3" />
              </div>
              <div>
                <span class="muted">Use two-step search</span>
                <div><input id="enableTwo" type="checkbox" checked> <label for="enableTwo" class="muted">Enabled</label></div>
              </div>
            </div>
          </div>
          <div>
            <label>Optional ΔE cutoff</label>
            <div class="stack">
              <input id="deltaCutoff" type="number" step="0.1" min="0" placeholder="e.g. 2.0 (optional)"/>
              <span class="muted">Lower = stricter match</span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>IRL Paint Mode</label>
            <div class="stack">
              <input id="irlMode" type="checkbox"> <span class="muted">Linear-light preview & target compensation</span>
            </div>
            <div class="stack" style="margin-top:8px">
              <span class="muted">Compensate brightness</span>
              <input id="comp" type="number" min="0.7" max="1.3" step="0.02" value="1.08" style="max-width:140px"/>
              <span class="muted">(try 1.06–1.12)</span>
            </div>
          </div>
          <div class="stack">
            <div class="swatch" id="matchSwatch" title="In‑game match"></div>
            <div>
              <div>In‑game match <code id="matchHex">#—</code> · ΔE <code id="matchDe">—</code></div>
              <div class="muted">(Lower ΔE ≈ closer visual match)</div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <div>Recipe Summary</div>
            <div id="summary" class="muted">—</div>
          </div>
        </div>

        <div class="pane result" id="result" style="margin-top:10px"></div>
        <footer class="pane">
          In‑game simulation uses Minecraft’s leather‑dye algorithm with brightness normalization (canvas base = white). IRL mode previews linear‑light mixing and lets you compensate the target so the in‑game result appears closer to real paint.
        </footer>
      </div>
    </div>
  </div>

<script>
// ---------- Data ----------
const DYES = {
  black:      [0x1D,0x1D,0x21], // #1D1D21
  red:        [0xAE,0x2D,0x26], // #AE2D26
  green:      [0x5D,0x7B,0x16], // #5D7B16
  brown:      [0x81,0x53,0x31], // #815331
  blue:       [0x3B,0x43,0xA8], // #3B43A8
  purple:     [0x87,0x31,0xB6], // #8731B6
  cyan:       [0x16,0x9A,0x9A], // #169A9A
  light_gray: [0x9B,0x9B,0x95], // #9B9B95
  gray:       [0x46,0x4E,0x51], // #464E51
  pink:       [0xF0,0x89,0xA8], // #F089A8
  lime:       [0x7E,0xC5,0x1F], // #7EC51F
  yellow:     [0xFB,0xD5,0x3C], // #FBD53C
  light_blue: [0x39,0xB1,0xD7], // #39B1D7
  magenta:    [0xC5,0x4D,0xBB], // #C54DBB
  orange:     [0xF6,0x7E,0x1D], // #F67E1D
  white:      [0xFF,0xFF,0xFF], // #FFFFFF
};
const DYE_NAMES = Object.keys(DYES);
const BASE = [255,255,255]; // canvas base = white

// ---------- Utilities ----------
const clamp255 = v=> Math.max(0, Math.min(255, Math.round(v)));
const floor255 = v=> Math.max(0, Math.min(255, Math.floor(v)));
const rgbStr = rgb=> `#${rgb.map(x=>x.toString(16).toUpperCase().padStart(2,'0')).join('')}`;
const parseHex = h=>{h=h.trim().replace(/^#/,''); if(h.length===3) h=[...h].map(ch=>ch+ch).join(''); if(h.length!==6) throw new Error('Use #RRGGBB'); return [0,2,4].map(i=>parseInt(h.slice(i,i+2),16)); };

function srgbToLin(c){ c/=255; return c<=0.04045? c/12.92 : Math.pow((c+0.055)/1.055,2.4); }
function linToSrgb(c){ return c<=0.0031308? 12.92*c : 1.055*Math.pow(c,1/2.4)-0.055; }
function rgbToLab([R,G,B]){
  const r=srgbToLin(R), g=srgbToLin(G), b=srgbToLin(B);
  const X=r*0.4124564 + g*0.3575761 + b*0.1804375;
  const Y=r*0.2126729 + g*0.7151522 + b*0.0721750;
  const Z=r*0.0193339 + g*0.1191920 + b*0.9503041;
  const Xn=0.95047, Yn=1.0, Zn=1.08883; const x=X/Xn, y=Y/Yn, z=Z/Zn;
  const f=t=> t>0.008856? Math.cbrt(t) : (7.787*t + 16/116);
  const fx=f(x), fy=f(y), fz=f(z);
  const L=116*fy-16, a=500*(fx-fy), b2=200*(fy-fz);
  return [L,a,b2];
}
function deltaE(rgb1,rgb2){ const [L1,a1,b1]=rgbToLab(rgb1), [L2,a2,b2]=rgbToLab(rgb2); return Math.hypot(L1-L2,a1-a2,b1-b2); }

// ---------- Mixing ----------
// Exact vanilla-style step (brightness normalization + floor), executed on the game canvas
function mixStepGame(current, dyeNames){
  const cols = [current, ...dyeNames.map(n=>DYES[n])];
  let r=0,g=0,b=0,maxSum=0;
  for(const c of cols){ r+=c[0]; g+=c[1]; b+=c[2]; maxSum+=Math.max(c[0],c[1],c[2]); }
  const n = cols.length;
  r /= n; g /= n; b /= n;                   // average channels (float)
  const avgMax = maxSum / n;                // average of per-color maxima
  const maxRGB = Math.max(r,g,b) || 1;
  const f = avgMax / maxRGB;                // normalization factor
  // floor after scaling, clamp 0..255
  r = floor255(r * f); g = floor255(g * f); b = floor255(b * f);
  return [r,g,b];
}

// Linear-light "IRL paint" preview of a step (no brightness normalization)
function mixStepLinear(current, dyeNames){
  const cols = [current, ...dyeNames.map(n=>DYES[n])];
  let r=0,g=0,b=0; const n=cols.length;
  for(const c of cols){ r+=srgbToLin(c[0]); g+=srgbToLin(c[1]); b+=srgbToLin(c[2]); }
  r/=n; g/=n; b/=n;
  return [r,g,b].map(x=> clamp255(linToSrgb(x)*255));
}

// ---------- Search ----------
function* combosWithReplacement(items, k, start=0, prefix=[]) {
  if(k===0){ yield prefix; return; }
  for(let i=start;i<items.length;i++){
    yield* combosWithReplacement(items, k-1, i, [...prefix, items[i]]);
  }
}

function tryOneStep(target, maxDyes){
  let best=null;
  for(let k=1;k<=maxDyes;k++){
    for(const combo of combosWithReplacement(DYE_NAMES,k)){
      const out=mixStepGame(BASE, combo);
      const d=deltaE(out, target);
      if(!best || d<best.d){ best={d, steps:[combo], out}; }
    }
  }
  return best;
}

function tryTwoSteps(target, maxPerStep){
  let best=null;
  for(let k1=1;k1<=maxPerStep;k1++){
    for(const s1 of combosWithReplacement(DYE_NAMES,k1)){
      const mid=mixStepGame(BASE, s1);
      for(let k2=1;k2<=maxPerStep;k2++){
        for(const s2 of combosWithReplacement(DYE_NAMES,k2)){
          const out=mixStepGame(mid, s2);
          const d=deltaE(out, target);
          if(!best || d<best.d){ best={d, steps:[s1,s2], out}; }
        }
      }
    }
  }
  return best;
}

function runSearch(){
  const hex=document.getElementById('hex').value || '#000000';
  const d1=parseInt(document.getElementById('d1').value||'4',10);
  const d2=parseInt(document.getElementById('d2').value||'3',10);
  const enableTwo=document.getElementById('enableTwo').checked;
  const cutoffStr=document.getElementById('deltaCutoff').value;
  const cutoff = cutoffStr? parseFloat(cutoffStr) : null;
  const irl = document.getElementById('irlMode').checked;
  const comp = parseFloat(document.getElementById('comp').value || '1.0');

  let target; try{ target=parseHex(hex); }catch(e){ alert(e.message); return; }

  // Update target swatch
  document.getElementById('targetSwatch').style.background=rgbStr(target);

  // If IRL mode, pre-compensate target brightness in linear space to better match real paint
  if(irl){
    let [R,G,B] = target.map(srgbToLin);
    R = Math.min(1, R*comp); G = Math.min(1, G*comp); B = Math.min(1, B*comp);
    target = [R,G,B].map(v=>clamp255(linToSrgb(v)*255));
  }

  const cands=[ tryOneStep(target,d1) ];
  if(enableTwo) cands.push( tryTwoSteps(target,d2) );
  const best=cands.reduce((a,b)=> a && a.d<=b.d ? a : b);

  if(cutoff!=null && best.d>cutoff){
    document.getElementById('matchSwatch').style.background='transparent';
    document.getElementById('matchHex').textContent = '#—';
    document.getElementById('matchDe').textContent = `${best.d.toFixed(2)} (> cutoff)`;
    document.getElementById('summary').textContent = `No recipe within ΔE ≤ ${cutoff}. Try increasing search depth or relaxing cutoff.`;
    document.getElementById('result').innerHTML='';
    return;
  }

  // Display overall match (in‑game)
  document.getElementById('matchSwatch').style.background=rgbStr(best.out);
  document.getElementById('matchHex').textContent=rgbStr(best.out);
  document.getElementById('matchDe').textContent=best.d.toFixed(2);

  // Build summary
  const summary = best.steps.map((s,i)=>`Step ${i+1}: ${s.join(', ')}`).join(' → ');
  document.getElementById('summary').textContent = summary;

  // Render steps with both previews (in‑game vs IRL)
  const result=document.getElementById('result');
  result.innerHTML='';
  let current=BASE;
  best.steps.forEach((dyes, idx)=>{
    const nextGame = mixStepGame(current, dyes);
    const nextIRL  = mixStepLinear(current, dyes);
    const el=document.createElement('div');
    el.className='step';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="swatch" style="width:36px;height:36px;background:${rgbStr(nextGame)}" title="In‑game"></div>
          <div class="swatch" style="width:36px;height:36px;background:${rgbStr(nextIRL)}" title="IRL (linear)"></div>
          <div>
            <div><b>Step ${idx+1}</b> · In‑game <code>${rgbStr(nextGame)}</code> · IRL <code>${rgbStr(nextIRL)}</code></div>
            <div class="muted">Add: ${dyes.map(n=>`<span class='pill'>${n.replace('_',' ')}</span>`).join('')}</div>
          </div>
        </div>
        <div class="muted">from ${rgbStr(current)}</div>
      </div>`;
    result.appendChild(el);
    current = nextGame; // subsequent steps use game logic as Minecraft would
  });
}

// ---------- Wire up ----------
const runBtn=document.getElementById('run');
runBtn.addEventListener('click', ()=>{ runBtn.disabled=true; runBtn.textContent='Searching…'; setTimeout(()=>{ runSearch(); runBtn.disabled=false; runBtn.textContent='Compute Recipe'; }, 10); });
window.addEventListener('DOMContentLoaded', ()=>{ try{ runSearch(); }catch{} });
</script>
</body>
</html>
